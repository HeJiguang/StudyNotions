# Linux权限


## 1. Linux权限管理

Linux系统的权限管理是其安全机制的核心部分，它确保用户只能访问和修改他们有权限的文件和目录。

### 1.1 文件权限表示

在Linux中，文件权限通常以如下形式显示：

```
-rwxr-xr--
```

这个字符串可以分解为四个部分：
- 第一个字符表示文件类型（`-`表示普通文件，`d`表示目录，`l`表示符号链接等）
- 接下来的三个字符（`rwx`）表示文件所有者的权限
- 再接下来的三个字符（`r-x`）表示文件所属组的权限
- 最后三个字符（`r--`）表示其他用户的权限

其中：
- `r`表示读权限（4）
- `w`表示写权限（2）
- `x`表示执行权限（1）
- `-`表示没有相应权限

### 1.2 chmod命令

chmod命令用于更改文件或目录的权限。

#### 1.2.1 符号模式

```bash
chmod [参数] [权限模式] [文件名]
```

符号模式使用字母和符号来表示权限：
- `u`：文件所有者
- `g`：文件所属组
- `o`：其他用户
- `a`：所有用户

权限操作符：
- `+`：添加权限
- `-`：移除权限
- `=`：设置精确权限

示例：
```bash
chmod u+x file.txt      # 给文件所有者添加执行权限
chmod g-w file.txt      # 移除文件所属组的写权限
chmod o=r file.txt      # 设置其他用户只有读权限
chmod a+rx directory    # 给所有用户添加读和执行权限
```

#### 1.2.2 数字模式  

数字模式使用三个八进制数字来表示权限，每个数字分别代表所有者、所属组和其他用户的权限：

```bash
chmod 755 file.txt      # rwxr-xr-x
chmod 644 file.txt      # rw-r--r--
chmod 700 file.txt      # rwx------
```

常用的权限组合：
- `777`：所有用户都有读、写、执行权限（不安全）
- `755`：所有者有全部权限，其他人只有读和执行权限（适用于目录和脚本）
- `644`：所有者有读写权限，其他人只有读权限（适用于普通文件）
- `700`：只有所有者有全部权限（私有文件）

#### 1.2.3 递归更改权限

使用`-R`选项可以递归地更改目录及其内容的权限：

```bash
chmod -R 755 directory
```

### 1.3 chown命令

chown命令用于更改文件或目录的所有者和所属组。

```bash
chown [选项] [所有者][:组] 文件
```

示例：
```bash
chown user1 file.txt               # 更改文件所有者为user1
chown user1:group1 file.txt        # 同时更改所有者和所属组
chown :group1 file.txt             # 只更改所属组
chown -R user1:group1 directory    # 递归更改目录及其内容的所有者和所属组
```

### 1.4 umask命令

umask命令用于设置新创建文件和目录的默认权限。

```bash
umask [掩码值]
```

掩码值是从完全权限中减去的值：
- 文件的完全权限是666（rw-rw-rw-）
- 目录的完全权限是777（rwxrwxrwx）

示例：
```bash
umask 022    # 新文件权限为644，新目录权限为755
umask 077    # 新文件权限为600，新目录权限为700
```

### 1.5 特殊权限

除了基本的读、写、执行权限外，Linux还支持一些特殊权限：

#### 1.5.1 SUID（Set User ID）

当一个可执行文件设置了SUID权限，用户执行该文件时将以文件所有者的身份运行。

```bash
chmod u+s file    # 设置SUID
chmod 4755 file   # 数字模式设置SUID
```

#### 1.5.2 SGID（Set Group ID）

当一个可执行文件设置了SGID权限，用户执行该文件时将以文件所属组的身份运行。当目录设置了SGID权限，在该目录下创建的新文件将继承该目录的所属组。

```bash
chmod g+s file    # 设置SGID
chmod 2755 file   # 数字模式设置SGID
```

#### 1.5.3 Sticky Bit

主要用于目录。当目录设置了Sticky Bit，只有文件所有者、目录所有者或root用户才能删除或重命名该目录中的文件。

```bash
chmod +t directory    # 设置Sticky Bit
chmod 1777 directory  # 数字模式设置Sticky Bit
```

## 2. Linux进程管理

进程是Linux系统中运行的程序实例。Linux提供了多种工具来监控和管理进程。

### 2.1 ps命令

ps命令用于显示当前运行的进程信息。

```bash
ps [选项]
```

常用选项：
- `-e`：显示所有进程
- `-f`：显示完整格式的输出
- `-l`：显示长格式输出
- `-u`：按用户名筛选进程

示例：
```bash
ps -ef                # 显示所有进程的详细信息
ps -u username        # 显示指定用户的进程
ps -ef | grep httpd   # 查找与httpd相关的进程
```

输出字段说明：
- `UID`：进程所有者的用户ID
- `PID`：进程ID
- `PPID`：父进程ID
- `C`：CPU使用率
- `STIME`：进程启动时间
- `TTY`：与进程关联的终端
- `TIME`：累计CPU时间
- `CMD`：执行的命令

### 2.2 top命令

top命令提供了实时的系统资源和进程活动监控。

```bash
top [选项]
```

常用选项：
- `-d`：指定刷新间隔（秒）
- `-p`：监控指定的进程ID
- `-u`：显示特定用户的进程
- `-b`：批处理模式（适用于脚本）

交互命令：
- `q`：退出
- `h`：显示帮助
- `k`：终止进程（需要输入PID）
- `r`：重新设置进程优先级
- `f`：选择显示字段
- `o`：改变显示顺序
- `M`：按内存使用率排序
- `P`：按CPU使用率排序
- `T`：按运行时间排序

### 2.3 kill命令

kill命令用于终止进程。

```bash
kill [选项] PID
```

常用选项：
- `-9`：强制终止进程（SIGKILL）
- `-15`：正常终止进程（SIGTERM，默认）
- `-l`：列出所有可用的信号

示例：
```bash
kill 1234            # 正常终止PID为1234的进程
kill -9 1234         # 强制终止PID为1234的进程
kill -l              # 列出所有可用的信号
```

### 2.4 killall命令

killall命令可以通过进程名而不是PID来终止进程。

```bash
killall [选项] 进程名
```

示例：
```bash
killall firefox       # 终止所有名为firefox的进程
killall -9 httpd      # 强制终止所有httpd进程
```

### 2.5 nice和renice命令

nice命令用于以指定的优先级启动进程，renice命令用于更改正在运行的进程的优先级。

优先级范围从-20（最高）到19（最低），默认为0。

```bash
nice -n 优先级 命令    # 以指定优先级启动命令
renice 优先级 -p PID   # 更改指定进程的优先级
```

示例：
```bash
nice -n 10 firefox    # 以较低优先级启动firefox
renice -5 -p 1234     # 提高PID为1234的进程优先级
```

### 2.6 nohup命令

nohup命令用于在用户退出登录后继续运行命令。

```bash
nohup 命令 [参数] &
```

示例：
```bash
nohup ./script.sh &   # 在后台运行script.sh，即使用户退出也不会终止
```

输出默认重定向到nohup.out文件。

### 2.7 jobs、bg和fg命令

这些命令用于管理作业控制：
- `jobs`：列出当前shell的作业
- `bg`：将作业放到后台运行
- `fg`：将作业放到前台运行

示例：
```bash
command &            # 在后台启动命令
Ctrl+Z               # 暂停当前前台作业
jobs                 # 列出所有作业
bg %1                # 将作业1放到后台运行
fg %1                # 将作业1放到前台运行
```

## 3. 文件系统管理

### 3.1 df命令

df命令用于显示文件系统的磁盘空间使用情况。

```bash
df [选项] [文件系统]
```

常用选项：
- `-h`：以人类可读的格式显示大小（KB、MB、GB）
- `-T`：显示文件系统类型
- `-i`：显示inode信息而非块使用量

示例：
```bash
df -h                # 显示所有文件系统的使用情况
df -h /dev/sda1      # 显示特定文件系统的使用情况
```

### 3.2 du命令

du命令用于显示目录或文件的磁盘使用量。

```bash
du [选项] [目录或文件]
```

常用选项：
- `-h`：以人类可读的格式显示大小
- `-s`：只显示总计
- `-a`：显示所有文件而非只显示目录
- `--max-depth=N`：限制显示的目录层级

示例：
```bash
du -h /home          # 显示/home目录的磁盘使用量
du -sh *             # 显示当前目录下各个项目的总大小
du --max-depth=1 -h  # 只显示当前目录下一级子目录的大小
```

### 3.3 mount和umount命令

mount命令用于挂载文件系统，umount命令用于卸载文件系统。

```bash
mount [选项] 设备 挂载点
umount 挂载点
```

示例：
```bash
mount /dev/sdb1 /mnt/usb     # 将/dev/sdb1挂载到/mnt/usb
umount /mnt/usb               # 卸载/mnt/usb
```

### 3.4 fdisk命令

fdisk是一个交互式的分区工具，用于创建和管理磁盘分区表。

```bash
fdisk [选项] 设备
```

常用选项：
- `-l`：列出指定设备的分区表

示例：
```bash
fdisk -l                      # 列出所有磁盘的分区表
fdisk /dev/sdb                # 启动交互式分区工具操作/dev/sdb
```

### 3.5 mkfs命令

mkfs命令用于在分区上创建文件系统。

```bash
mkfs -t 文件系统类型 设备
```

示例：
```bash
mkfs -t ext4 /dev/sdb1        # 在/dev/sdb1上创建ext4文件系统
mkfs.ext4 /dev/sdb1           # 同上，使用特定格式的命令
```

## 4. 网络管理命令

### 4.1 ifconfig命令

ifconfig命令用于配置和显示网络接口信息。

```bash
ifconfig [接口] [参数]
```

示例：
```bash
ifconfig                      # 显示所有活动接口的信息
ifconfig eth0                 # 显示特定接口的信息
ifconfig eth0 up              # 启用eth0接口
ifconfig eth0 down            # 禁用eth0接口
```

### 4.2 ip命令

ip命令是ifconfig的现代替代品，提供更多功能。

```bash
ip [选项] 对象 命令
```

常用对象：
- `addr`：地址管理
- `link`：网络设备管理
- `route`：路由表管理

示例：
```bash
ip addr show                  # 显示所有接口的地址信息
ip link set eth0 up           # 启用eth0接口
ip route show                 # 显示路由表
```

### 4.3 netstat命令

netstat命令用于显示网络连接、路由表和网络接口统计信息。

```bash
netstat [选项]
```

常用选项：
- `-t`：显示TCP连接
- `-u`：显示UDP连接
- `-l`：显示监听的套接字
- `-n`：不解析名称（显示IP地址和端口号）
- `-p`：显示进程ID和名称

示例：
```bash
netstat -tulpn               # 显示所有监听的TCP和UDP端口及其关联的进程
netstat -an | grep ESTABLISHED # 显示所有已建立的连接
```

### 4.4 ss命令

ss命令是netstat的现代替代品，提供更详细的套接字统计信息。

```bash
ss [选项]
```

常用选项与netstat类似。

示例：
```bash
ss -tulpn                    # 显示所有监听的TCP和UDP端口
ss -s                        # 显示套接字统计信息
```

### 4.5 ping命令

ping命令用于测试与另一台主机的连接。

```bash
ping [选项] 主机
```

常用选项：
- `-c`：指定发送的数据包数量
- `-i`：指定发送间隔（秒）
- `-s`：指定数据包大小

示例：
```bash
ping -c 4 google.com         # 向google.com发送4个数据包
```

### 4.6 traceroute命令

traceroute命令用于显示数据包到达目标主机所经过的路由。

```bash
traceroute [选项] 主机
```

示例：
```bash
traceroute google.com         # 显示到google.com的路由
```

## 5. 系统监控命令

### 5.1 free命令

free命令用于显示系统内存使用情况。

```bash
free [选项]
```

常用选项：
- `-h`：以人类可读的格式显示
- `-s`：每隔指定秒数显示一次
- `-t`：显示总计行

示例：
```bash
free -h                      # 以人类可读的格式显示内存使用情况
free -s 5                    # 每5秒更新一次内存使用情况
```

### 5.2 vmstat命令

vmstat命令用于报告虚拟内存统计信息。

```bash
vmstat [选项] [延迟 [计数]]
```

示例：
```bash
vmstat 2 5                   # 每2秒报告一次，共报告5次
```

### 5.3 iostat命令

iostat命令用于报告CPU统计信息和输入/输出统计信息。

```bash
iostat [选项] [延迟 [计数]]
```

示例：
```bash
iostat -x 2 5                # 每2秒报告一次扩展统计信息，共报告5次
```

### 5.4 sar命令

sar命令用于收集、报告和保存系统活动信息。

```bash
sar [选项] [间隔 [计数]]
```

示例：
```bash
sar -u 2 5                   # 每2秒报告一次CPU使用情况，共报告5次
sar -r                       # 显示今天的内存使用情况
```

## 6. 实用技巧与最佳实践

### 6.1 权限管理最佳实践

1. **最小权限原则**：只给用户和程序必要的最小权限
2. **避免使用777权限**：这会使文件对所有人完全开放，存在安全风险
3. **定期审计权限**：使用`find / -perm -4000 -o -perm -2000 -ls`查找具有SUID/SGID权限的文件
4. **使用组管理权限**：创建适当的用户组，通过组权限管理访问控制
5. **保护重要配置文件**：确保/etc目录下的配置文件有适当的权限

### 6.2 进程管理技巧

1. **使用screen或tmux**：长时间运行的任务应在screen或tmux会话中执行，防止SSH断开导致进程终止
2. **合理设置优先级**：CPU密集型后台任务应使用nice降低优先级
3. **监控系统负载**：定期检查load average，避免系统过载
4. **设置资源限制**：使用ulimit限制进程可使用的资源
5. **使用systemd管理服务**：对于需要长期运行的服务，创建systemd服务单元

### 6.3 文件系统维护

1. **定期检查磁盘空间**：设置cron任务监控磁盘使用情况
2. **保持文件系统整洁**：定期清理临时文件和日志
3. **备份重要数据**：使用rsync等工具定期备份
4. **检查文件系统错误**：使用fsck检查和修复文件系统错误
5. **监控inode使用情况**：使用`df -i`检查inode使用情况

### 6.4 Shell脚本技巧

1. **使用函数组织代码**：将重复的操作封装为函数
2. **错误处理**：检查命令执行状态并处理错误
3. **日志记录**：记录脚本执行过程和结果
4. **参数验证**：验证脚本输入参数
5. **使用trap捕获信号**：优雅地处理中断和终止信号

```bash
#!/bin/bash

# 函数定义
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> /var/log/myscript.log
}

# 错误处理
set -e  # 遇到错误立即退出

# 信号处理
trap 'echo "脚本被中断"; exit 1' INT TERM

# 参数验证
if [ $# -lt 1 ]; then
    echo "用法: $0 <参数>"
    exit 1
fi

# 主逻辑
log "开始执行脚本"
# 执行操作...
log "脚本执行完成"
```

### 6.5 安全加固技巧

1. **禁用不必要的服务**：减少攻击面
2. **定期更新系统**：应用安全补丁
3. **配置防火墙**：使用iptables或firewalld限制网络访问
4. **监控登录尝试**：检查/var/log/auth.log或/var/log/secure
5. **使用SSH密钥认证**：禁用密码登录，使用密钥认证
6. **限制sudo访问**：只给必要的用户sudo权限，并限制可执行的命令

## 总结

Linux的权限管理和进程管理是系统管理的核心部分。掌握这些命令和概念不仅可以帮助你更有效地管理Linux系统，还能提高系统的安全性和稳定性。通过实践和不断学习，你将能够更加熟练地运用这些工具来解决实际问题。